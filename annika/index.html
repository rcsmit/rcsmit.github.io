<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annika Timer 2.0</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    :root {
      --bg-main: #050509;
      --card-bg: #14151c;
      --card-bg-top: #1e1f2a;
      --accent: #7a63ff;
      --accent-muted: #2b2c3b;
      --accent-warning: #f5a623;
      --text-main: #ffffff;
      --text-sub: #8c8fa8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #232437 0, var(--bg-main) 55%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .logo {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 120px;
      height: auto;
      border-radius: 50%;
      z-index: 10;
    }

    .timer-shell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      padding: 24px 16px;
    }

    .timer-card {
      width: 320px;
      max-width: 90vw;
      background: linear-gradient(180deg, var(--card-bg-top), var(--card-bg));
      border-radius: 28px;
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.7);
      padding: 28px 16px 32px;
      position: relative;
    }

    .timer-card-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .progress-ring-wrapper {
      position: relative;
      width: 220px;
      height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress-ring-svg {
      position: absolute;
      inset: 0;
      transform: rotate(-90deg);
    }

    .progress-ring-bg {
      stroke: #242533;
      opacity: 0.85;
    }

    .progress-ring-value {
      stroke: var(--accent);
      stroke-linecap: round;
      transition: stroke-dashoffset 0.25s ease;
      filter: drop-shadow(0 0 12px rgba(122, 99, 255, 0.7));
    }

    .time-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    #timerDisplay {
      font-size: 2.8rem;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    #timerSubtitle {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-sub);
    }

    .controls-row {
      margin-top: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 22px;
    }

    .control-button {
      width: 68px;
      height: 68px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      background-color: var(--accent-muted);
      color: var(--text-main);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.6);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background-color 0.12s ease, opacity 0.12s ease;
    }

    .control-button.primary {
      background-color: var(--accent-warning);
      color: #151515;
    }

    .control-button:active {
      transform: translateY(2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.7);
    }

    .control-button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .copyright {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.65rem;
      color: var(--text-sub);
      opacity: 0.7;
      pointer-events: none;
    }

    /* Side menu (settings) */

    .menu {
      position: fixed;
      top: 0;
      right: 0;
      width: 300px;
      height: 100vh;
      background-color: #d8d4d4;
      padding: 20px;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0.25s ease, opacity 0.25s ease;
      overflow-y: auto;
      color: #111;
      z-index: 40;
    }

    .menu.open {
      visibility: visible;
      opacity: 1;
    }

    .menu h2 {
      margin-top: 32px;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
      gap: 8px;
      font-size: 0.9rem;
    }

    .toggle-label-up,
    .toggle-label-down {
      min-width: 70px;
      text-align: center;
    }

    .toggle-switch {
      position: relative;
      width: 56px;
      height: 30px;
    }

    .toggle {
      appearance: none;
      width: 100%;
      height: 100%;
      background-color: #c6c6c6;
      border-radius: 16px;
      outline: none;
      cursor: pointer;
      transition: background-color 0.3s;
      position: relative;
    }

    .toggle-indicator {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background-color: #fff;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    #timeInput {
      display: flex;
      margin: 16px 0 10px;
      justify-content: center;
      gap: 10px;
    }

    .input-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 0.8rem;
    }

    .input-container label {
      margin-bottom: 4px;
    }

    .input-container input {
      width: 64px;
      height: 32px;
      font-size: 0.9rem;
      text-align: center;
      border-radius: 8px;
      border: 1px solid #b0b0b0;
    }

    .menu button {
      margin-top: 10px;
      width: 100%;
      border-radius: 12px;
      padding: 10px 12px;
      border: 0;
      background-color: #333;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .menu button:active {
      background-color: #555;
    }

    /* Loading overlay */

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .overlay-content {
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      color: #121212;
      min-width: 220px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-bar {
      width: 200px;
      height: 20px;
      background-color: #f3f3f3;
      border-radius: 10px;
      margin: 10px auto;
      overflow: hidden;
    }

    .progress {
      width: 0%;
      height: 100%;
      background-color: #3498db;
      transition: width 0.3s ease;
    }

    @media (max-width: 480px) {
      .timer-card {
        width: 280px;
        padding: 22px 12px 26px;
      }

      .progress-ring-wrapper {
        width: 200px;
        height: 200px;
      }

      #timerDisplay {
        font-size: 2.4rem;
      }

      .control-button {
        width: 60px;
        height: 60px;
        font-size: 1.4rem;
      }

      .logo {
        width: 90px;
      }
    }

    .menu-close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        border: none;
        background: #333;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
      }

  </style>
</head>
<body>
  <img src="logo.png" alt="Logo" class="logo">

  <div class="menu" id="menu">
     
    <h2>Timer settings</h2>
    <div class="toggle-container">
      <div class="toggle-label-up">Count Down</div>
      <label class="toggle-switch">
        <input type="checkbox" class="toggle" id="countingToggle">
        <span class="toggle-indicator" id="toggleIndicator"></span>
      </label>
      <div class="toggle-label-down">Count Up</div>
    </div>

    <div id="timeInput">
      <div class="input-container">
        <label for="hourInput">Hours</label>
        <input type="number" id="hourInput" value="0" min="0" max="23">
      </div>
      <div class="input-container">
        <label for="minuteInput">Minutes</label>
        <input type="number" id="minuteInput" value="1" min="0" max="59">
      </div>
      <div class="input-container">
        <label for="secondInput">Seconds</label>
        <input type="number" id="secondInput" value="5" min="0" max="59">
      </div>
    </div>

    <div class="input-container">
      <label for="intervalInput">Interval to scream (seconds)</label>
      <input type="number" id="intervalInput" value="10">
    </div>
    <button id="setStartTimeBtn">Set Start Time</button>
    <button class="menu-close-btn" id="menuCloseBtn">✕</button>

    <div class="copyright">2126 Made by Rene Smit for Marcel and Annika</div>
  </div>

  <div class="timer-shell">
    <div class="timer-card">
      <div class="timer-card-inner">
        <div class="progress-ring-wrapper">
          <svg class="progress-ring-svg" width="220" height="220">
            <circle
              class="progress-ring-bg"
              stroke-width="14"
              fill="transparent"
              r="96"
              cx="110"
              cy="110"
            />
            <circle
              id="progressRing"
              class="progress-ring-value"
              stroke-width="14"
              fill="transparent"
              r="96"
              cx="110"
              cy="110"
            />
          </svg>
          <div class="time-content">
            <div id="timerDisplay">00:01:00</div>
            <div id="timerSubtitle">REMAINING</div>
          </div>
        </div>

        <div class="controls-row" id="controls">
          <button class="control-button" id="resetMainBtn" title="Reset">
            ⟳
          </button>
          <button class="control-button primary" id="mainControlBtn" title="Start">
            ▶
          </button>
          <button class="control-button" id="menuToggleBtn" title="Settings">
            ⚙
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="overlay">
    <div class="overlay-content">
      <div id="message" class="message"><p>Click to load audiofiles</p></div>
      <div class="progress-bar" style="display: none;">
        <div id="progressBar" class="progress"></div>
      </div>
      <p id="progressText" style="display: none;">0 / 62 files loaded</p>
    </div>
  </div>

  <script>
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    const bgColorArray = ['#181822', '#202336', '#14161f', '#1e2538', '#181b2c'];
    const timerDisplay = document.getElementById('timerDisplay');
    const timerSubtitle = document.getElementById('timerSubtitle');
    const countingToggle = document.getElementById('countingToggle');
    const toggleIndicator = document.getElementById('toggleIndicator');
    const timeInput = document.getElementById('timeInput');
    const hourInput = document.getElementById('hourInput');
    const minuteInput = document.getElementById('minuteInput');
    const secondInput = document.getElementById('secondInput');
    const intervalInput = document.getElementById('intervalInput');
    const menu = document.getElementById('menu');
    const controls = document.getElementById('controls');
    const mainControlBtn = document.getElementById('mainControlBtn');
    const resetMainBtn = document.getElementById('resetMainBtn');
    const progressRing = document.getElementById('progressRing');

    let running = false;
    let countingDown = true;
    let startTime = 65;
    let seconds = startTime;
    let audioContext;
    let audioBuffers = {};
    let audioLoaded = false;
    let timerInterval;
    let ringRadius;
    let ringCircumference;

    function initProgressRing() {
      ringRadius = progressRing.r.baseVal.value;
      ringCircumference = 2 * Math.PI * ringRadius;
      progressRing.style.strokeDasharray = `${ringCircumference} ${ringCircumference}`;
      progressRing.style.strokeDashoffset = ringCircumference;
    }

    function setRingProgress(fraction) {
      if (!ringCircumference) return;
      const clamped = Math.min(Math.max(fraction, 0), 1);
      const offset = ringCircumference - clamped * ringCircumference;
      progressRing.style.strokeDashoffset = offset;
    }

    function initAudioContext() {
      const AudioContextConstructor = window.AudioContext || window.webkitAudioContext;
      if (!audioContext) {
        audioContext = new AudioContextConstructor();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume().catch(() => {});
      }
      loadAudioFiles();
    }

    function resumeAudioContext() {
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume().catch(() => {});
      }
    }

    function loadAudioFiles() {
      const audioFiles = Array.from({ length: 60 }, (_, i) => (i + 1).toString()).concat(['0', 'hours', 'minutes', 'seconds']);
      let loadedCount = 0;
      const totalFiles = audioFiles.length;
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      const loadFile = (file, retryCount = 0) => {
        fetch(`audio-numbers/${file}.wav`)
          .then(response => {
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            return response.arrayBuffer();
          })
          .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
          .then(audioBuffer => {
            audioBuffers[file] = audioBuffer;
            loadedCount++;
            updateLoadingProgress(loadedCount, totalFiles);
            if (loadedCount === totalFiles) {
              audioLoaded = true;
              setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                updateControls();
              }, 100);
            }
          })
          .catch(() => {
            if (retryCount < 3) {
              setTimeout(() => loadFile(file, retryCount + 1), 500);
            }
          });
      };

      audioFiles.forEach(file => loadFile(file));
    }

    function addTouchClickHandler(elementId, handler) {
      const element = document.getElementById(elementId);
      if (!element) return;

      element.addEventListener('touchstart', function () {
        resumeAudioContext();
      }, { passive: true });

      element.addEventListener('touchend', function (e) {
        if (e.cancelable) e.preventDefault();
        resumeAudioContext();
        handler(e);
      });

      element.addEventListener('click', function (e) {
        resumeAudioContext();
        handler(e);
      });
    }

    // function toggleMenu() {
    //   menu.classList.toggle('open');
    // }

    function toggleMenu(event) {
      if (event) event.stopPropagation();
      menu.classList.toggle('open');
    }

    function setStartTime() {
      const totalSeconds = parseInt(hourInput.value || '0', 10) * 3600
        + parseInt(minuteInput.value || '0', 10) * 60
        + parseInt(secondInput.value || '0', 10);

      if (countingDown) {
        if (!isNaN(totalSeconds) && totalSeconds >= 0) {
          startTime = totalSeconds || 0;
          seconds = startTime;
        }
      } else {
        if (!isNaN(totalSeconds) && totalSeconds >= 0) {
          startTime = totalSeconds;
        } else {
          startTime = 0;
        }
        seconds = 0;
      }
      updateTimerDisplay();
    }

    function startTimer() {
      if (!audioContext) {
        initAudioContext();
      } else {
        resumeAudioContext();
      }

      if (!running) {
        running = true;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
      }
      updateControls();
    }

    function pauseTimer() {
      running = false;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      updateTimerDisplay();
    }

    function resetTimer() {
      running = false;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (countingDown) {
        seconds = startTime;
      } else {
        seconds = 0;
      }
      updateTimerDisplay();
    }

    function updateTimer() {
      if (!countingDown) {
        seconds++;
      } else {
        if (seconds === 0) {
          pauseTimer();
          return;
        }
        seconds--;
      }

      const intervalVal = parseInt(intervalInput.value || '0', 10);
      if ((intervalVal > 0 && seconds % intervalVal === 0) || (countingDown && seconds < 10)) {
        screamNumber(seconds);
        changeBackgroundColor();
      }

      updateTimerDisplay();
    }

    function screamNumber(number) {
      const hours = Math.floor(number / 3600);
      const minutes = Math.floor((number % 3600) / 60);
      const seconds_ = Math.floor(number % 60);

      let delay = 0;
      const playWithDelay = word => {
        delay += 1100;
        setTimeout(() => playWord(word), delay);
      };
      const playWithoutDelay = word => {
        delay = 0;
        setTimeout(() => playWord(word), delay);
      };

      if (hours > 0) {
        playWithoutDelay(hours.toString());
        playWithDelay('hours');
      }

      if (hours === 0 && minutes > 0) {
        playWithoutDelay(minutes.toString());
        playWithDelay('minutes');
      }
      if (hours !== 0 && minutes > 0) {
        playWithDelay(minutes.toString());
        playWithDelay('minutes');
      }
      if (hours !== 0 && minutes === 0) {
        playWithDelay(minutes.toString());
        playWithDelay('minutes');
      }

      if (hours === 0 && minutes === 0 && seconds_ > 10) {
        playWithoutDelay(seconds_.toString());
        playWithDelay('seconds');
      }
      if (hours !== 0 && minutes === 0 && seconds_ > 10) {
        playWithDelay(seconds_.toString());
        playWithDelay('seconds');
      }
      if (hours === 0 && minutes !== 0 && seconds_ > 10) {
        playWithDelay(seconds_.toString());
        playWithDelay('seconds');
      }
      if (hours !== 0 && minutes !== 0 && seconds_ > 10) {
        playWithDelay(seconds_.toString());
        playWithDelay('seconds');
      }

      if (seconds_ <= 10) {
        if (hours === 0 && minutes === 0) {
          playWithoutDelay(seconds_.toString());
        } else {
          playWithDelay(seconds_.toString());
          playWithDelay('seconds');
        }
      }
    }

    function playWord(word) {
      if (!audioContext) {
        initAudioContext();
        return;
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => playWordWithContext(word)).catch(() => {});
      } else {
        playWordWithContext(word);
      }
    }

    function playWordWithContext(word) {
      if (!audioBuffers[word]) return;
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffers[word];
      source.connect(audioContext.destination);
      try {
        source.start(0);
      } catch {
        audioContext.resume().then(() => {
          try {
            const retrySource = audioContext.createBufferSource();
            retrySource.buffer = audioBuffers[word];
            retrySource.connect(audioContext.destination);
            retrySource.start(0);
          } catch {
          }
        }).catch(() => {});
      }
    }

    function changeBackgroundColor() {
      const randomColor = bgColorArray[Math.floor(Math.random() * bgColorArray.length)];
      document.body.style.backgroundColor = randomColor;
    }

    function updateTimerDisplay() {
      const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
      const secs = String(seconds % 60).padStart(2, '0');
      timerDisplay.textContent = `${hours}:${minutes}:${secs}`;
      timerSubtitle.textContent = countingDown ? 'REMAINING' : 'ELAPSED';

      let fraction = 0;
      if (countingDown && startTime > 0) {
        fraction = 1 - seconds / startTime;
      } else if (!countingDown && startTime > 0) {
        fraction = seconds / startTime;
      }
      setRingProgress(fraction);
      updateControls();
    }

    function updateLoadingProgress(loaded, total) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const percentage = (loaded / total) * 100;
      progressBar.style.width = `${percentage}%`;
      progressText.textContent = `${loaded} / ${total} files loaded`;
    }

    function updateControls() {
      if (!audioLoaded) {
        mainControlBtn.disabled = true;
        mainControlBtn.textContent = '...';
        return;
      }
      mainControlBtn.disabled = false;

      if (running) {
        mainControlBtn.textContent = '⏸';
      } else {
        const showStart =
          (countingDown && (seconds === startTime || startTime === 0 && seconds === 0)) ||
          (!countingDown && seconds === 0);
        mainControlBtn.textContent = showStart ? '▶' : '⏯';
      }
    }

    function handleMainControl() {
      if (!audioLoaded) return;
      if (running) {
        pauseTimer();
      } else {
        startTimer();
      }
      updateControls();
    }

    
    function setupEventHandlers() {
      addTouchClickHandler('menuToggleBtn', toggleMenu);
      addTouchClickHandler('setStartTimeBtn', setStartTime);
      addTouchClickHandler('mainControlBtn', handleMainControl);
      addTouchClickHandler('resetMainBtn', resetTimer);
      addTouchClickHandler('menuCloseBtn', function (e) {
        if (e) e.stopPropagation();
        menu.classList.remove('open');
      });
      if (isIOS) {
        document.getElementById('loadingOverlay').addEventListener('click', function () {
          resumeAudioContext();
        });
      }

      countingToggle.addEventListener('change', () => {
        countingDown = !countingDown;
        toggleIndicator.style.left = countingDown ? '2px' : '28px';
        timeInput.style.display = 'flex';
        setStartTime();
      });

      document.body.addEventListener('touchstart', function () {
        resumeAudioContext();
      }, { passive: true });
    }

    function initializeApp() {
      initProgressRing();
      setupEventHandlers();

      const overlay = document.getElementById('loadingOverlay');
      const overlayContent = document.querySelector('.overlay-content');
      const progressText = document.getElementById('progressText');
      const progressBar = document.querySelector('.progress-bar');
      const message = document.getElementById('message');

      if (overlayContent && progressText) {
        progressText.textContent = 'Loading files';
        progressBar.style.display = 'none';
        progressText.style.display = 'none';
      }

      overlay.addEventListener('click', function () {
        if (message) message.style.display = 'none';
        progressBar.style.display = 'block';
        progressText.style.display = 'block';
        progressText.textContent = 'Loading audio files...';

        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        overlayContent.insertBefore(spinner, overlayContent.firstChild);

        initAudioContext();
      }, { once: true });

      toggleIndicator.style.left = '2px';
      updateTimerDisplay();

      document.addEventListener('click', function (e) {
        if (!menu.classList.contains('open')) return;
        if (menu.contains(e.target)) return;
        if (e.target.id === 'menuToggleBtn') return;
        menu.classList.remove('open');
      });
    }

    window.addEventListener('load', initializeApp);

    window.addEventListener('pageshow', function (event) {
      if (event.persisted) {
        initializeApp();
      }
    });

    document.addEventListener('visibilitychange', function () {
      if (document.visibilityState === 'visible') {
        resumeAudioContext();
      }
    });
  </script>
</body>
</html>
